%% INITAEB.m - Initialisation simplifi√©e bas√©e uniquement sur headwayOffset
clc;
clear;

%% üîπ Charger le sc√©nario
scenario = choisirScenario();  % Appelle automatiquement readScenario()

%% üîπ Param√®tres g√©n√©raux
Ts = getfield(scenario, 'Ts', 0.1);
SimStopTime = getfield(scenario, 'SimStopTime', 10);

%% üîπ Param√®tres du v√©hicule √©go
ego = scenario.EgoVehicle;
x0_vech = ego.x0;
y0_vech = ego.y0;
v0_vech = ego.v0;
yaw0_vech = ego.yaw0;
ydot_o = getfield(ego, 'ydot', 0);
delta_vech = getfield(ego, 'delta', 0);

%% üîπ Param√®tres du v√©hicule cible
cible = scenario.TargetVehicle;
x0_cible = cible.x0;
y0_cible = cible.y0;
v0_cible = cible.v0;
yaw0_cible = getfield(cible, 'yaw0', 0);
delta_cible = getfield(cible, 'delta', 0);

%% üîπ Param√®tre unique : headwayOffset
if isfield(scenario, 'FRU') && isfield(scenario.FRU, 'headwayOffset')
    headwayOffset = scenario.FRU.headwayOffset;
else
    headwayOffset = 1.0;  % Valeur par d√©faut
end

%% üîπ Affichage final
fprintf("\n‚úÖ Sc√©nario '%s' charg√© avec succ√®s !\n", scenario.NomScenario);
conducteurActive_var = Simulink.Parameter;
conducteurActive_var.Value = 1;  % Par d√©faut Off
conducteurActive_var.DataType = 'boolean'; 
conducteurActive_var.CoderInfo.StorageClass = 'ExportedGlobal';
%  Variable d'erreur syst√®me dynamique (modifiable en simulation)
if ~exist('erreurSysteme_var', 'var')
    erreurSysteme_var = Simulink.Signal;
    erreurSysteme_var.DataType = 'boolean';
    erreurSysteme_var.CoderInfo.StorageClass = 'SimulinkGlobal';
    erreurSysteme_var.InitialValue = '0'; % Valeur initiale
end

% Texte pour affichage
Pas_en_panne = "Pas en panne";
en_panne = "En panne";


if ~exist('commandeAEB', 'var')
   commandeAEB = Simulink.Signal;
    commandeAEB.DataType = 'boolean';
    commandeAEB.CoderInfo.StorageClass = 'SimulinkGlobal';
   commandeAEB.InitialValue = '0'; % Valeur initiale
end
if ~exist('inattentionConducteur', 'var')
   inattentionConducteur = Simulink.Signal;
    inattentionConducteur.DataType = 'boolean';
    inattentionConducteur.CoderInfo.StorageClass = 'SimulinkGlobal';
   inattentionConducteur.InitialValue = '0'; % Valeur initiale
end
if ~exist('Securite', 'var')
  Securite = Simulink.Signal;
    Securite.DataType = 'boolean';
    Securite.CoderInfo.StorageClass = 'SimulinkGlobal';
   Securite.InitialValue = '0'; % Valeur initiale
end